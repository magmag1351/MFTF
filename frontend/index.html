<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fatigue Monitor AI</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div id="app" v-cloak>
        <div class="background-glow"></div>

        <header>
            <div class="logo">
                <h1>Fatigue Monitor <span class="badge">AI</span></h1>
            </div>

            <nav>
                <a class="nav-link" :class="{ active: currentView === 'monitor' }"
                    @click="currentView = 'monitor'">Monitor</a>
                <a class="nav-link" :class="{ active: currentView === 'tasks' }"
                    @click="currentView = 'tasks'">Tasks</a>
                <a class="nav-link" :class="{ active: currentView === 'history' }"
                    @click="currentView = 'history'">History</a>
                <a class="nav-link" :class="{ active: currentView === 'settings' }"
                    @click="currentView = 'settings'">Settings</a>
            </nav>

            <div class="status-indicator" :class="{ active: socketConnected }">
                <div class="dot"></div>
                <span>{{ socketConnected ? 'Connected' : 'Disconnected' }}</span>
            </div>
        </header>

        <main v-show="currentView === 'monitor'">
            <!-- Left Column: Camera -->
            <div class="card camera-card">
                <div class="card-header">
                    <h2>Live Feed</h2>
                    <span class="live-tag">LIVE</span>
                </div>
                <div class="video-container">
                    <!-- Local Video Preview (High Performance) -->
                    <video id="webcamVideo" autoplay playsinline muted></video>
                    <!-- Visual Guide Overlay (Optional, drawn by JS if needed) -->

                    <div v-if="cameraError" class="placeholder error">
                        <p>Camera Error: {{ cameraError }}</p>
                    </div>

                    <div v-if="!cameraReady && !cameraError" class="placeholder">
                        <div class="loader"></div>
                        <p>Waiting for camera permissions...</p>
                    </div>

                    <div v-if="status === 'away'" class="overlay">
                        <div class="away-badge">
                            <h3>Away Mode</h3>
                            <p>Resuming in {{ formatTime(awayRemaining) }}</p>
                            <button @click="resume">Resume Now</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Stats & Controls -->
            <div class="right-column">
                <!-- KPI Cards -->
                <div class="kpi-grid">
                    <div class="card kpi-card">
                        <h3>Current Fatigue</h3>
                        <div class="value" :class="getFatigueClass(fatigue)">
                            {{ fatigue }}<span class="unit">%</span>
                        </div>
                    </div>
                    <div class="card kpi-card">
                        <h3>Predicted (+60s)</h3>
                        <div class="value" :class="getFatigueClass(prediction)">
                            {{ prediction }}<span class="unit">%</span>
                        </div>
                    </div>
                </div>

                <!-- Chart -->
                <div class="card chart-card">
                    <div class="card-header">
                        <h2>Fatigue Trend</h2>
                    </div>
                    <div class="chart-container">
                        <canvas id="fatigueChart"></canvas>
                    </div>
                </div>

                <!-- Controls -->
                <div class="controls-grid">
                    <button class="btn btn-away" @click="setAway">
                        <span class="btn-icon">‚òï</span>
                        Take a Break (5m)
                    </button>

                    <button class="btn" :class="musicPlaying ? 'btn-stop' : 'btn-play'" @click="toggleMusic">
                        <span class="btn-icon">{{ musicPlaying ? '‚è∏' : '‚ñ∂' }}</span>
                        {{ musicPlaying ? 'Stop Music' : 'Play Music' }}
                    </button>
                </div>
            </div>
        </main>

        <main v-show="currentView === 'tasks'">
            <div class="tasks-container">
                <div class="card-header">
                    <h2>Task Management</h2>
                </div>

                <div class="task-input-group">
                    <input type="text" class="task-input" placeholder="What needs to be done?" v-model="newTaskTitle"
                        @keyup.enter="addTask">
                    <button class="btn btn-save" style="padding: 0 24px;" @click="addTask">Add Task</button>
                </div>

                <div class="kanban-board">
                    <!-- TODO -->
                    <div class="kanban-column">
                        <div class="column-header">
                            <h3>Todo</h3>
                            <span class="task-count">{{ tasks.filter(t => t.status === 'todo').length }}</span>
                        </div>
                        <div class="task-list">
                            <div v-for="task in tasks.filter(t => t.status === 'todo')" :key="task.id"
                                class="task-card">
                                <div class="task-info">
                                    <span class="task-title">{{ task.title }}</span>
                                </div>
                                <div class="task-actions">
                                    <span class="task-status-badge status-todo"
                                        @click="toggleTaskStatus(task)">Start</span>
                                    <button class="btn-icon-delete" @click="deleteTask(task.id)">üóë</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- IN PROGRESS -->
                    <div class="kanban-column">
                        <div class="column-header">
                            <h3 style="color: var(--primary);">In Progress</h3>
                            <span class="task-count">{{ tasks.filter(t => t.status === 'in_progress').length }}</span>
                        </div>
                        <div class="task-list">
                            <div v-for="task in tasks.filter(t => t.status === 'in_progress')" :key="task.id"
                                class="task-card" style="border-color: var(--primary-glow);">
                                <div class="task-info">
                                    <span class="task-title">{{ task.title }}</span>
                                </div>
                                <div class="task-actions">
                                    <span class="task-status-badge status-in_progress"
                                        @click="toggleTaskStatus(task)">Complete</span>
                                    <button class="btn-icon-delete" @click="deleteTask(task.id)">üóë</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DONE -->
                    <div class="kanban-column">
                        <div class="column-header">
                            <h3 style="color: #30D158;">Done</h3>
                            <span class="task-count">{{ tasks.filter(t => t.status === 'done').length }}</span>
                        </div>
                        <div class="task-list">
                            <div v-for="task in tasks.filter(t => t.status === 'done')" :key="task.id"
                                class="task-card">
                                <div class="task-info">
                                    <span class="task-title" style="text-decoration: line-through; opacity: 0.6;">{{
                                        task.title }}</span>
                                </div>
                                <div class="task-actions">
                                    <span class="task-status-badge status-done"
                                        @click="toggleTaskStatus(task)">Revert</span>
                                    <button class="btn-icon-delete" @click="deleteTask(task.id)">üóë</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <main v-show="currentView === 'history'">
            <div class="history-container">
                <div class="card-header">
                    <h2>History Log</h2>
                </div>

                <!-- Summary Grid -->
                <div class="history-summary">
                    <div class="summary-card">
                        <span class="label">Average Fatigue</span>
                        <span class="value">{{ stats.avg_fatigue }}%</span>
                    </div>
                    <div class="summary-card">
                        <span class="label">Total Alerts</span>
                        <span class="value">{{ stats.total_alerts }}</span>
                    </div>
                    <div class="summary-card">
                        <span class="label">Work Time</span>
                        <span class="value">{{ stats.total_time }}h</span>
                    </div>
                </div>

                <!-- Table -->
                <div class="history-table-container">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Duration</th>
                                <th>Peak Fatigue</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="session in history" :key="session.id">
                                <td>{{ session.timestamp }}</td>
                                <td>{{ session.duration }}</td>
                                <td>{{ session.peak }}%</td>
                                <td>
                                    <span class="fatigue-badge" :class="getBadgeClass(session.peak)">
                                        {{ getStatusLabel(session.peak) }}
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>

        <main v-show="currentView === 'settings'">
            <div class="settings-container">
                <div class="card-header">
                    <h2>Settings</h2>
                </div>

                <div class="settings-grid">
                    <!-- Monitoring Settings -->
                    <div class="settings-card">
                        <h3>Monitoring</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Fatigue Threshold</span>
                                <span class="setting-value">{{ settings.fatigueThreshold }}%</span>
                            </div>
                            <input type="range" min="50" max="100" v-model="settings.fatigueThreshold">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Predictive Alerts</span>
                                <label class="switch">
                                    <input type="checkbox" v-model="settings.enablePredictiveAlerts">
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Audio Settings -->
                    <div class="settings-card">
                        <h3>Audio</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Alert Volume</span>
                                <span class="setting-value">{{ settings.alertVolume }}%</span>
                            </div>
                            <input type="range" min="0" max="100" v-model="settings.alertVolume">
                        </div>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Test Alert Sound</span>
                                <button class="btn btn-stop" style="padding: 8px 16px; font-size: 0.8rem;"
                                    @click="playAlert">
                                    Play Test
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="settings-card">
                        <h3>Data Management</h3>
                        <div class="setting-item">
                            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 16px;">
                                Permanently delete all recorded fatigue sessions from the database.
                            </p>
                            <button class="btn-danger-outline" @click="clearHistory">
                                üóë Clear Session History
                            </button>
                        </div>
                    </div>

                    <!-- Appearance -->
                    <div class="settings-card">
                        <h3>Appearance</h3>
                        <div class="setting-item">
                            <div class="setting-label">
                                <span>Accent Color</span>
                            </div>
                            <div style="display: flex; gap: 12px; margin-top: 10px;">
                                <div @click="updateAccentColor('#64D2FF')"
                                    style="width: 24px; height: 24px; border-radius: 50%; background: #64D2FF; cursor: pointer;"
                                    :style="{ border: settings.accentColor === '#64D2FF' ? '2px solid white' : 'none' }">
                                </div>
                                <div @click="updateAccentColor('#BF5AF2')"
                                    style="width: 24px; height: 24px; border-radius: 50%; background: #BF5AF2; cursor: pointer;"
                                    :style="{ border: settings.accentColor === '#BF5AF2' ? '2px solid white' : 'none' }">
                                </div>
                                <div @click="updateAccentColor('#30D158')"
                                    style="width: 24px; height: 24px; border-radius: 50%; background: #30D158; cursor: pointer;"
                                    :style="{ border: settings.accentColor === '#30D158' ? '2px solid white' : 'none' }">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="save-section">
                        <button class="btn-save" @click="saveSettings">Save All Changes</button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Audio Elements -->
        <audio id="bgMusic" src="/resources/videoplayback.mp4" loop></audio>
        <!-- alertSound is now handled via Web Audio API in app.js -->
        <!-- Simplify: use standard beep or synthesis in JS -->

    </div>

    <script src="/static/app.js"></script>
</body>

</html>